- block:
  - name: set up AWS credentials
    set_fact:
      aws_connection_info:
        aws_region: '{{ aws_region }}'
        aws_access_key: '{{ aws_access_key }}'
        aws_secret_key: '{{ aws_secret_key }}'
        security_token: '{{ security_token }}'
    no_log: true
  - name: test with no parameters
    register: result
    ignore_errors: true
    ansible.amazon.lambda_policy: null
  - name: assert failure when called with no parameters
    assert:
      that:
      - result.failed
      - 'result.msg.startswith("missing required arguments: ")'
  - name: test with all required dummy parameters but no region
    ignore_errors: true
    register: result
    ansible.amazon.lambda_policy:
      statement_id: dummy
      principal: api_fakeway
      action: fake:do_something_fake
      function_name: dummy_fake_function
  - name: assert failure and appropriate message when called without region
    assert:
      that:
      - result.failed
      - '"region must be specified" in result.msg'
  - name: test with all required dummy parameters but no region
    ignore_errors: true
    register: result
    ansible.amazon.lambda_policy:
      statement_id: dummy
      principal: api_fakeway
      action: fake:do_something_fake
      function_name: dummy_fake_function
      region: null
  - name: assert failure and appropriate message when called false region region
    assert:
      that:
      - result.failed
      - '"region must be specified" in result.msg'
  - name: test exceptions generated by forcing bad ec2 url
    register: result
    ignore_errors: true
    ansible.amazon.lambda_policy:
      function_name: '{{ lambda_function_name }}'
      state: present
      statement_id: api-gateway-invoke-lambdas
      action: lambda:InvokeFunction
      principal: apigateway.amazonaws.com
      source_arn: arn:aws:execute-api:no-north-0:1234567:*/*
      ec2_url: https://noexist.example.com
      ec2_region: no-north-0
      ec2_access_key: iamnotreallyanaccesskey
      ec2_secret_key: thisisabadsecretkey
      security_token: andthisisabadsecuritytoken
  - name: assert lambda manages to respond as expected
    assert:
      that:
      - result is failed
      - result.msg != "MODULE FAILURE"
      - result.changed == False
  - name: move lambda into place for archive module
    copy:
      src: mini_http_lambda.py
      dest: '{{output_dir}}/mini_http_lambda.py'
  - name: bundle lambda into a zip
    register: zip_res
    ansible.misc.archive:
      format: zip
      path: '{{output_dir}}/mini_http_lambda.py'
      dest: '{{output_dir}}/mini_http_lambda.zip'
  - name: create minimal lambda role
    register: iam_role
    ansible.amazon.iam_role:
      aws_region: '{{ aws_region }}'
      aws_access_key: '{{ aws_access_key }}'
      aws_secret_key: '{{ aws_secret_key }}'
      security_token: '{{ security_token }}'
      name: ansible_lambda_role
      assume_role_policy_document: '{{ lookup(''file'', ''minimal_trust_policy.json'',
        convert_data=False) }}'
      create_instance_profile: false
  - name: wait 10 seconds for role to become available
    pause:
      seconds: 10
    when: iam_role.changed
  - name: test state=present - upload the lambda
    register: lambda_result
    ansible.amazon.lambda:
      aws_region: '{{ aws_region }}'
      aws_access_key: '{{ aws_access_key }}'
      aws_secret_key: '{{ aws_secret_key }}'
      security_token: '{{ security_token }}'
      name: '{{lambda_function_name}}'
      runtime: python2.7
      handler: mini_http_lambda.handler
      role: ansible_lambda_role
      zip_file: '{{zip_res.dest}}'
  - name: get the aws account ID for use in future commands
    register: aws_caller_info
    ansible.amazon.aws_caller_info:
      aws_region: '{{ aws_region }}'
      aws_access_key: '{{ aws_access_key }}'
      aws_secret_key: '{{ aws_secret_key }}'
      security_token: '{{ security_token }}'
  - name: register lambda uri for use in template
    set_fact:
      mini_lambda_uri: arn:aws:apigateway:{{ aws_region }}:lambda:path/2015-03-31/functions/arn:aws:lambda:{{
        aws_region }}:{{ aws_caller_info.account }}:function:{{ lambda_result.configuration.function_name
        }}/invocations
  - name: build API file
    template:
      src: endpoint-test-swagger-api.yml.j2
      dest: '{{output_dir}}/endpoint-test-swagger-api.yml.j2'
  - name: deploy new API
    register: create_result
    ansible.amazon.aws_api_gateway:
      aws_region: '{{ aws_region }}'
      aws_access_key: '{{ aws_access_key }}'
      aws_secret_key: '{{ aws_secret_key }}'
      security_token: '{{ security_token }}'
      api_file: '{{output_dir}}/endpoint-test-swagger-api.yml.j2'
      stage: lambdabased
  - name: register api id for later
    set_fact:
      api_id: '{{ create_result.api_id }}'
  - name: check API fails with permissions failure
    uri:
      url: https://{{create_result.api_id}}.execute-api.{{aws_region}}.amazonaws.com/lambdabased/mini/Mr_Ansible_Tester
    register: unauth_uri_result
    ignore_errors: true
  - name: assert internal server error due to permissions
    assert:
      that:
      - unauth_uri_result is failed
      - unauth_uri_result.status == 500
  - name: give api gateway execute permissions on lambda
    ansible.amazon.lambda_policy:
      aws_region: '{{ aws_region }}'
      aws_access_key: '{{ aws_access_key }}'
      aws_secret_key: '{{ aws_secret_key }}'
      security_token: '{{ security_token }}'
      function_name: '{{ lambda_function_name }}'
      state: present
      statement_id: api-gateway-invoke-lambdas
      action: lambda:InvokeFunction
      principal: apigateway.amazonaws.com
      source_arn: arn:aws:execute-api:{{ aws_region }}:{{ aws_caller_info.account
        }}:*/*
  - name: try again but with ARN
    ansible.amazon.lambda_policy:
      aws_region: '{{ aws_region }}'
      aws_access_key: '{{ aws_access_key }}'
      aws_secret_key: '{{ aws_secret_key }}'
      security_token: '{{ security_token }}'
      function_name: '{{ lambda_result.configuration.function_arn }}'
      state: present
      statement_id: api-gateway-invoke-lambdas
      action: lambda:InvokeFunction
      principal: apigateway.amazonaws.com
      source_arn: arn:aws:execute-api:{{ aws_region }}:{{ aws_caller_info.account
        }}:*/*
  - name: check API works with execute permissions
    uri:
      url: https://{{create_result.api_id}}.execute-api.{{aws_region}}.amazonaws.com/lambdabased/mini/Mr_Ansible_Tester
    register: uri_result
  - name: assert API works success
    assert:
      that:
      - uri_result
  - name: deploy new API
    register: create_result
    ignore_errors: true
    ansible.amazon.aws_api_gateway:
      aws_region: '{{ aws_region }}'
      aws_access_key: '{{ aws_access_key }}'
      aws_secret_key: '{{ aws_secret_key }}'
      security_token: '{{ security_token }}'
      api_file: '{{output_dir}}/endpoint-test-swagger-api.yml.j2'
      stage: lambdabased
  always:
  - name: destroy lambda for test cleanup if created
    register: result
    ignore_errors: true
    ansible.amazon.lambda:
      aws_region: '{{ aws_region }}'
      aws_access_key: '{{ aws_access_key }}'
      aws_secret_key: '{{ aws_secret_key }}'
      security_token: '{{ security_token }}'
      name: '{{lambda_function_name}}'
      state: absent
  - name: destroy API for test cleanup if created
    register: destroy_result
    ignore_errors: true
    ansible.amazon.aws_api_gateway:
      aws_region: '{{ aws_region }}'
      aws_access_key: '{{ aws_access_key }}'
      aws_secret_key: '{{ aws_secret_key }}'
      security_token: '{{ security_token }}'
      state: absent
      api_id: '{{api_id}}'
